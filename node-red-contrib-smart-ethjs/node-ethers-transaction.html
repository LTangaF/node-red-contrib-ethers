<script type="text/javascript">
  // Caches
  let abiData = null;
  let abiDataAddress = null;

  RED.nodes.registerType('ethers-transaction', {
    category: 'Ethers',
    color: '#a3b5d2',
    defaults: {
      name: { value: undefined },
      network: { value: undefined, required: true, type: 'ethjs-network' },
      wallet: { value: undefined, required: true, type: 'ethjs-wallet' },
      output: { value: 'payload', required: false },
      outputType: { value: 'msg' },
      wait: { value: false },

      address: { value: 'payload', required: false },
      addressType: { value: 'msg' },
      ether: { value: 'payload', required: false },
      etherType: { value: 'msg' },

      contract: { value: undefined, type: 'ethers-contract', required: true },
      apiCall: { value: undefined },
      unit: { value: undefined },
      params: { value: undefined },
      param0: { value: undefined },
      typeParam0: { value: undefined },
      param1: { value: undefined },
      typeParam1: { value: undefined },
      param2: { value: undefined },
      typeParam2: { value: undefined },
      param3: { value: undefined },
      typeParam3: { value: undefined },
      param4: { value: undefined },
      typeParam4: { value: undefined },
      param5: { value: undefined },
      typeParam5: { value: undefined },
      param6: { value: undefined },
      typeParam6: { value: undefined },
    },
    inputs: 1,
    outputs: 1,
    icon: 'ethjs.png',
    align: 'left',
    paletteLabel: 'Transaction',
    hasValue: true,
    label: function() {
      return this.name || 'Ethereum Transaction';
    },
    oneditprepare: function() {
      const node = this;
      console.log('oneditprepare');
      if (!this.outputType) this.outputType = 'msg';
      $('#node-input-output').typedInput({ default: 'msg', types: ['msg'], typeField: $('#node-input-outputType') });

      if (!this.addressType) this.addressType = 'msg';
      $('#node-input-address').typedInput({
        default: 'msg',
        types: ['msg', 'str'],
        typeField: $('#node-input-addressType')
      });

      if (!this.etherType) this.etherType = 'msg';
      $('#node-input-ether').typedInput({
        default: 'msg',
        types: ['msg', 'str'],
        typeField: $('#node-input-etherType')
      });

      // TODO test
      const onABI = (type, value) => {
        if (!abiData) {
          console.error('no abiData on change');
          return;
        }
        const selectedFunc = type ? type.target.selectedOptions[0].value : node.apiCall;

        const p = abiData
          .filter(x => x.name === selectedFunc)[0]
          .inputs.map((mi, i) => Object.assign({ label: mi.name || mi.type, i: i }, mi));

        console.log('tp', selectedFunc, p);

        // Make question nodes
        const paramNodes = p.map((x) => {
            const l = x.label;
          return `<div class="form-row">
                        <label for="node-input-param${x.i}"><i class="icon-tag"></i>${x.i+1}. ${l}</label>
                        <input type="text" id="node-input-param${x.i}" placeholder="">
                        <input type="hidden" id="node-input-typeParam${x.i}">
                    </div>`;
        });
        $('#contract-params').html(paramNodes.join(''));
        

        // typedInput each param
        p.forEach((x, i) => {
          const paramString = `node-input-param${x.i}`;
          $(`label[for='${paramString}']`).html(i + 1 + '. ' + x.label);

          const pNode = $('#' + paramString);

          const paramValue = node[`param${i}`];
          console.log('paramValue', paramValue);
          pNode.val(paramValue);

          pNode.typedInput({
            default: node[`typeParam${x.i}`] || 'str',
            value: node[`typeParam${x.i}`] || 'str', // this[`node-input-param${x.i}`]
            types: ['msg', 'str'],
            typeField: $(`#node-input-typeParam${x.i}`)
          });
        });
      };

      $('#node-input-apiCall').on('change', (type, value) => {
        onABI(type, value);
      });

      const decorateFuncNames = funcs => {
        console.log('decorateInputs2', funcs);
        // return;

        $('#node-input-apiCall').empty();
        // Todo keep option around DEFAULT Select
        // console.log('decorateInputs', node.apiCall);
        funcs.forEach((x, i) => {
          x = x.name;
          // const _node = $('#node-input-apiCall option');
          // $('#node-input-apiCall option').eq(i).text(x) // .value(x)
          //  .prop('selected', x===node.apiCall);
          // console.log('x', x);
          $('#node-input-apiCall').append(
            $('<option></option>')
              .val(x)
              .text(x)
              .prop('selected', x === node.apiCall)
          );
        });
      };

      $('#node-input-contract').on('change', (type, value) => {
        // WORKS!
        // const v = $("#node-input-contract").typedInput('value');
        const t = type.target.selectedOptions[0].value;
        // console.log('type', type, t);
        // console.log('t', t, t.selectedOptions[0].value);
        const address = RED.nodes.node(t).address;
        // console.log('change node', address);

        if ((abiDataAddress === address || !abiDataAddress) && abiData) {
          // console.log('reusing data');
          decorateFuncNames(abiData);
        } else
          $.post('abi', { address: address }, function(data) {
            // abiDataAddress
            abiDataAddress = address;
            // console.log('serialports test', data);

            /// $('#node-input-apiCall').typedInput({default: '', types:data.funcs.map(x=>x.name)});
            const t = data.funcs.map(x => x.name);
            abiData = data.funcs;
            // console.log('got data', abiData);
            decorateFuncNames(abiData);

            // Populate params
            onABI();
          });
      });
      // $("#node-input-ether").typedInput({ default: 'msg', types: ['msg','str'], typeField: $("#node-input-etherType") });
    },
    oneditcancel: function() {
      console.log('oneditcancel transaction');
    },
    oneditsave: function() {
      console.log('oneditsave transaction');
      const ns = $('#contract-params [id^="node-input-param"]');
      if (ns.length === 0) console.log('no params found');

      const params = new Array(ns.length);
      ns.each(function(x) {
        const n = $(this)[0];
        const fieldIndex = parseInt(n.id.replace('node-input-param', ''));
        const val = n.value;
        params[fieldIndex] = val;
        console.log('field', fieldIndex, val);
      });

      this.params = params;
      console.log('this.params', this.params);
    }
  });
</script>
<style>
  h4.section {
    border-bottom: 1px solid #bbb;
    margin: 1em 0em 1em 0em;
  }
  .input-info {
    font-size: 12px;
    padding-left: 104px;
    font-style: italic;
  }
  .checkbox-info {
    font-size: 12px;
  }
</style>
<script type="text/x-red" data-template-name="ethers-transaction">

  <h4 class="section">General</h4>

  <div class="form-row">
      <label for="node-input-name"><i class="icon-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="">
  </div>
  <div class="form-row">
      <label for="node-input-network"><i class="icon-tag"></i> Network</label>
      <input type="text" id="node-input-network" placeholder="">
  </div>
  <div class="form-row">
      <label for="node-input-wallet"><i class="icon-tag"></i> Wallet</label>
      <input type="text" id="node-input-wallet" placeholder="">
      <div class="input-info">This wallet will sign the transaction</div>
  </div>
  <div class="form-row">
      <label for="node-input-output"><i class="icon-tag"></i> Output</label>
      <input type="text" id="node-input-output" style="width:70%;" placeholder="payload">
      <input type="hidden" id="node-input-outputType">
  </div>
  <div class="form-row">
      <label for="node-input-wait"><i class="icon-tag"></i> Wait</label>
      <input type="checkbox" style="width: auto;" id="node-input-wait"> <span class="checkbox-info">(wait a valid transaction)</span>
  </div>
  <h4 class="section">Transaction</h4>

  <div class="form-row">
      <label for="node-input-address"><i class="icon-tag"></i> Address</label>
      <input type="text" id="node-input-address" style="width:70%;" placeholder="payload">
      <input type="hidden" id="node-input-addressType">
      <div class="input-info">Leave empty to use wallet's public address</div>
  </div>

  <div class="form-row">
      <label for="node-input-ether"><i class="icon-tag"></i> Wei</label>
      <input type="text" id="node-input-ether" style="width:70%;" placeholder="payload">
      <input type="hidden" id="node-input-etherType">
      <div class="input-info">Leave empty to get the balance</div>
  </div>

  <h4 class="section">Contract</h4>

  <div class="form-row">
      <label for="node-input-contract"><i class="icon-tag"></i> Contract</label>
      <input type="text" id="node-input-contract" placeholder="">
  </div>
  <div class="form-row">
      <label for="node-input-apiCall"><i class="icon-tag"></i> API Call</label>
      <select id="node-input-apiCall" style="width:260px">
          <option /><option /><option /><option /><option /><option /><option /><option /><option />
          <option /><option /><option /><option /><option /><option /><option /><option /><option />
          <option /><option /><option /><option /><option /><option /><option /><option /><option />
          <option /><option /><option /><option /><option /><option /><option /><option /><option />
      </select>

      <select id="node-input-unit" style="width:auto">
          <option value=""></option>
          <option value="wei">Wei</option>
          <option value="ether">Ether</option>
      </select>
  </div>

  <div class="form-row node-input-rule-container-row">
      <ol id="node-input-rule-container"></ol>
  </div>
  <div id="contract-params">
    <div class="form-row">
      <label for="node-input-param0"><i class="icon-tag"></i>0.</label>
      <input type="text" id="node-input-param0" placeholder="">
      <input type="hidden" id="node-input-typeParam0">
    </div>
    <div class="form-row">
      <label for="node-input-param1"><i class="icon-tag"></i>1.</label>
      <input type="text" id="node-input-param1" placeholder="">
      <input type="hidden" id="node-input-typeParam1">
    </div>
    <div class="form-row">
      <label for="node-input-param2"><i class="icon-tag"></i>2.</label>
      <input type="text" id="node-input-param2" placeholder="">
      <input type="hidden" id="node-input-typeParam2">
    </div>
    <div class="form-row">
      <label for="node-input-param3"><i class="icon-tag"></i>3.</label>
      <input type="text" id="node-input-param3" placeholder="">
      <input type="hidden" id="node-input-typeParam3">
    </div>
    <div class="form-row">
      <label for="node-input-param4"><i class="icon-tag"></i>4.</label>
      <input type="text" id="node-input-param4" placeholder="">
      <input type="hidden" id="node-input-typeParam4">
    </div>
    <div class="form-row">
      <label for="node-input-param5"><i class="icon-tag"></i>5.</label>
      <input type="text" id="node-input-param5" placeholder="">
      <input type="hidden" id="node-input-typeParam5">
    </div>
    <div class="form-row">
      <label for="node-input-param6"><i class="icon-tag"></i>6.</label>
      <input type="text" id="node-input-param6" placeholder="">
      <input type="hidden" id="node-input-typeParam6">
    </div>
  </div>
</script>

<script type="text/x-red" data-help-name="ethers-transaction">
  <p>[<i>under development</i>]</p>

  <h3>References</h3>
  <ul>
      <li><a href="https://docs.ethers.io/ethers.js/html/">Ethers.js</a> - documentation</li>
  </ul>
</script>
