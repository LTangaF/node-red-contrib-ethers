<script type="text/javascript">
  RED.nodes.registerType('ethers-transaction', {
    category: 'Ethers',
    color: '#a3b5d2',
    defaults: {
      name: { value: undefined },
      network: { value: undefined, required: true, type: 'ethjs-network' },
      wallet: { value: undefined, required: true, type: 'ethjs-wallet' },
      output: { value: 'payload', required: false },
      outputType: { value: 'msg' },
      wait: { value: false },

      address: { value: 'payload', required: false },
      addressType: { value: 'msg' },
      ether: { value: 'payload', required: false },
      etherType: { value: 'msg' },

      contract: { value: undefined, type: 'ethers-contract', required: true },
      apiCall: { value: undefined },
      unit: { value: undefined },
      param1: { value: undefined },
      param2: { value: undefined },
      param3: { value: undefined }
    },
    inputs: 1,
    outputs: 1,
    icon: 'ethjs.png',
    align: 'left',
    paletteLabel: 'Transaction',
    hasValue: true,
    label: function() {
      return this.name || 'Ethereum Transaction';
    },
    oneditprepare: function() {
      console.log('oneditprepare');
      if (!this.outputType) this.outputType = 'msg';
      $('#node-input-output').typedInput({ default: 'msg', types: ['msg'], typeField: $('#node-input-outputType') });

      if (!this.addressType) this.addressType = 'msg';
      $('#node-input-address').typedInput({
        default: 'msg',
        types: ['msg', 'str'],
        typeField: $('#node-input-addressType')
      });

      if (!this.etherType) this.etherType = 'msg';
      $('#node-input-ether').typedInput({
        default: 'msg',
        types: ['msg', 'str'],
        typeField: $('#node-input-etherType')
      });

      // TODO test
      let abiData = null;
      $('#node-input-apiCall').on('change', (type, value) => {
        if (!abiData) return;
        const t = type.target.selectedOptions[0].value;
        const p = abiData.filter(x => x.name === t)[0].inputs.map(mi => mi.name || mi.type);
        console.log('tp', t, p);

        const a = p.map((x, i) => {
          return `<div class="form-row">
                        <label for="node-input-param-${x}"><i class="icon-tag"></i> ${x}</label>
                        <input type="text" id="node-input-param-${x}" placeholder="">
                    </div>`;
        });
        $('#contract-params').html(a.join(''));

        p.forEach((x, i) => {
            $(`#node-input-param-${x}`).typedInput({
                default: 'str',
                'value': '',
                types: ['msg', 'str']
            });
        });
      });

      $('#node-input-contract').on('change', (type, value) => {
        // WORKS!
        // const v = $("#node-input-contract").typedInput('value');
        const t = type.target.selectedOptions[0].value;
        console.log('type', type, t);
        // console.log('t', t, t.selectedOptions[0].value);
        const address = RED.nodes.node(t).address;
        console.log('change node', address);

        $.post('abi', { address: address }, function(data) {
          console.log('serialports test', data);
          $('#node-input-apiCall').empty();
          /// $('#node-input-apiCall').typedInput({default: '', types:data.funcs.map(x=>x.name)});
          const t = data.funcs.map(x => x.name);
          abiData = data.funcs;
          t.forEach(x =>
            $('#node-input-apiCall').append(
              $('<option></option>')
                .val(x)
                .html(x)
            )
          );
        });
      });
      // $("#node-input-ether").typedInput({ default: 'msg', types: ['msg','str'], typeField: $("#node-input-etherType") });
    },
    oneditcancel: function() {
      console.log('oneditcancel transaction');
    },
    oneditsave: function() {
      console.log('oneditsave transaction');
      const ns = $('#contract-params [id^="node-input-param-"]');
      if(ns.length===0) console.log('no params found');

      const params = {};
      ns.each(function(x) {
          const n = $(this)[0];
          const field = n.id.replace('node-input-param-', '');
          const val = n.value;
          params[field] = val;
        console.log('field', field, val);
      });

      this.param1 = params;
    }
  });
</script>
<style>
  h4.section {
    border-bottom: 1px solid #bbb;
    margin: 1em 0em 1em 0em;
  }
  .input-info {
    font-size: 12px;
    padding-left: 104px;
    font-style: italic;
  }
  .checkbox-info {
    font-size: 12px;
  }
</style>
<script type="text/x-red" data-template-name="ethers-transaction">

  <h4 class="section">General</h4>

  <div class="form-row">
      <label for="node-input-name"><i class="icon-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="">
  </div>
  <div class="form-row">
      <label for="node-input-network"><i class="icon-tag"></i> Network</label>
      <input type="text" id="node-input-network" placeholder="">
  </div>
  <div class="form-row">
      <label for="node-input-wallet"><i class="icon-tag"></i> Wallet</label>
      <input type="text" id="node-input-wallet" placeholder="">
      <div class="input-info">This wallet will sign the transaction</div>
  </div>
  <div class="form-row">
      <label for="node-input-output"><i class="icon-tag"></i> Output</label>
      <input type="text" id="node-input-output" style="width:70%;" placeholder="payload">
      <input type="hidden" id="node-input-outputType">
  </div>
  <div class="form-row">
      <label for="node-input-wait"><i class="icon-tag"></i> Wait</label>
      <input type="checkbox" style="width: auto;" id="node-input-wait"> <span class="checkbox-info">(wait a valid transaction)</span>
  </div>
  <h4 class="section">Transaction</h4>

  <div class="form-row">
      <label for="node-input-address"><i class="icon-tag"></i> Address</label>
      <input type="text" id="node-input-address" style="width:70%;" placeholder="payload">
      <input type="hidden" id="node-input-addressType">
      <div class="input-info">Leave empty to use wallet's public address</div>
  </div>

  <div class="form-row">
      <label for="node-input-ether"><i class="icon-tag"></i> Wei</label>
      <input type="text" id="node-input-ether" style="width:70%;" placeholder="payload">
      <input type="hidden" id="node-input-etherType">
      <div class="input-info">Leave empty to get the balance</div>
  </div>

  <h4 class="section">Contract</h4>

  <div class="form-row">
      <label for="node-input-contract"><i class="icon-tag"></i> Contract</label>
      <input type="text" id="node-input-contract" placeholder="">
  </div>
  <div class="form-row">
      <label for="node-input-apiCall"><i class="icon-tag"></i> API Call</label>
      <select id="node-input-apiCall" style="width:260px" onchange="this.nextElementSibling.value=this.value">
          <option value=""></option>
      </select>

      <select id="node-input-unit" style="width:auto">
          <option value=""></option>
          <option value="wei">Wei</option>
          <option value="ether">Ether</option>
      </select>
  </div>

  <div class="form-row node-input-rule-container-row">
      <ol id="node-input-rule-container"></ol>
  </div>

  <div id="contract-params">

  </div>
</script>

<script type="text/x-red" data-help-name="ethers-transaction">
  <p>[<i>under development</i>]</p>

  <h3>References</h3>
  <ul>
      <li><a href="https://blog.encausse.net/2018/03/28/le-chatbot-comme-interface-de-la-blockchain/">Encausse.net</a> - blog article</li>
      <li><a href="https://github.com/ethjs/ethjs">EthJS</a> - documentation</li>
      <li><a href="https://github.com/NGRP/node-red-contrib-viseo/">VISEO BotMaker</a> - the nodes github repository</li>
  </ul>
</script>
